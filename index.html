<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<title>館長のリズムゲーム</title>

<style>
body{
    margin:0;
    background:#0b0f1a;
    color:white;
    font-family:sans-serif;
    text-align:center;
    touch-action:manipulation;
}

h1{
    margin:10px;
    font-size:28px;
}

#score{
    font-size:20px;
    margin-bottom:5px;
}

#game{
    position:relative;
    margin:auto;
    width:95vw;
    max-width:600px;
    height:70vh;
    max-height:800px;
    background:#111;
    overflow:hidden;
    border:4px solid #444;
    border-radius:12px;
}

.lane{
    position:absolute;
    bottom:0;
    width:33.33%;
    height:100%;
    border-left:2px solid #333;
}

#hitline{
    position:absolute;
    bottom:120px;
    width:100%;
    height:6px;
    background:yellow;
}

.note{
    position:absolute;
    width:33.33%;
    height:26px;
    background:cyan;
    border-radius:6px;
}

button{
    width:30vw;
    max-width:160px;
    height:70px;
    margin:6px;
    font-size:24px;
    border-radius:12px;
}

#start{
    background:#28a745;
    color:white;
    font-size:22px;
    width:200px;
    height:60px;
}
</style>
</head>

<body>

<h1>館長のリズムゲーム</h1>

<div id="score">
Score: <span id="s">0</span>
Combo: <span id="c">0</span>
</div>

<button id="start" onclick="startGame()">スタート</button>

<div id="game">
    <div class="lane" style="left:0%"></div>
    <div class="lane" style="left:33.33%"></div>
    <div class="lane" style="left:66.66%"></div>
    <div id="hitline"></div>
</div>

<div>
<button onclick="hit(0)">A</button>
<button onclick="hit(1)">S</button>
<button onclick="hit(2)">D</button>
</div>

<script>
let score=0
let combo=0
let notes=[]
let running=false

// ===== 音生成（100%鳴る） =====
let audioCtx=null

function initAudio(){
    if(!audioCtx){
        audioCtx=new (window.AudioContext||window.webkitAudioContext)()
    }
}

function playHit(){
    const osc=audioCtx.createOscillator()
    const gain=audioCtx.createGain()

    osc.connect(gain)
    gain.connect(audioCtx.destination)

    osc.frequency.value=700
    osc.type="square"

    gain.gain.setValueAtTime(0.3,audioCtx.currentTime)
    gain.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.15)

    osc.start()
    osc.stop(audioCtx.currentTime+0.15)
}

// ===== ゲーム開始 =====
function startGame(){
    initAudio()
    running=true
}

// ===== ノーツ生成 =====
function spawnNote(){
    if(!running) return

    let lane=Math.floor(Math.random()*3)

    let n=document.createElement("div")
    n.className="note"
    n.style.left=(lane*33.33)+"%"
    n.style.top="0px"
    document.getElementById("game").appendChild(n)

    notes.push({el:n,lane:lane,y:0})
}

setInterval(spawnNote,650)

// ===== 落下 =====
function gameLoop(){
    if(!running) return

    let hitY=document.getElementById("game").offsetHeight-140

    notes.forEach((n,i)=>{
        n.y+=5
        n.el.style.top=n.y+"px"

        if(n.y>hitY+80){
            miss(n,i)
        }
    })
}
setInterval(gameLoop,16)

// ===== ヒット =====
function hit(lane){
    if(!running) return

    let hitY=document.getElementById("game").offsetHeight-140
    let window=40

    for(let i=0;i<notes.length;i++){
        let n=notes[i]

        if(n.lane===lane && Math.abs(n.y-hitY)<window){

            score+=100
            combo++
            playHit()
            update()

            n.el.remove()
            notes.splice(i,1)
            return
        }
    }

    combo=0
    update()
}

function miss(n,i){
    combo=0
    update()
    n.el.remove()
    notes.splice(i,1)
}

function update(){
    document.getElementById("s").textContent=score
    document.getElementById("c").textContent=combo
}
</script>

</body>
</html>
