<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>リズムゲーム 黄色線基準</title>

<style>
body{
    margin:0;
    background:black;
    overflow:hidden;
    touch-action:manipulation;
    font-family:sans-serif;
    color:white;
}

#game{
    position:relative;
    width:100vw;
    height:100vh;
}

.note{
    position:absolute;
    width:30%;
    height:60px;
    border-radius:50%;
}

#judge{
    position:absolute;
    bottom:80px;       /* 黄色線を下に */
    width:100%;
    height:160px;
    border-top:3px solid yellow;
}

#ui{
    position:absolute;
    top:10px;
    left:10px;
}

#ranking{
    position:absolute;
    right:10px;
    top:10px;
    font-size:14px;
}
</style>
</head>

<body>

<div id="game">
    <div id="ui">
        スコア: <span id="score">0</span><br>
        残り時間: <span id="time">60</span>
    </div>

    <div id="ranking"></div>

    <div id="judge"></div>
</div>

<script>
const game = document.getElementById("game");
const scoreEl = document.getElementById("score");
const timeEl = document.getElementById("time");
const rankingEl = document.getElementById("ranking");

let score = 0;
let notes = [];
let timeLeft = 60;
let playing = true;

const judgeY = window.innerHeight - 80;
const judgeRange = 160;

//--------------------------------
// タップ音（色別）
function playBeep(color){
    const ctx = new AudioContext();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.type = "square";

    if(color==="blue") o.frequency.value=300;
    else if(color==="green") o.frequency.value=500;
    else o.frequency.value=700;

    o.start();
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.15);
}

//--------------------------------
// ノーツ生成
//--------------------------------
setInterval(()=>{
    if(!playing) return;

    const note = document.createElement("div");
    note.className="note";

    const lane = Math.floor(Math.random()*3);
    note.lane = lane;
    note.style.left = (lane*33.33)+"%";
    note.y = -60;

    const r = Math.random();
    if(r<0.33) note.color="blue";
    else if(r<0.66) note.color="green";
    else note.color="red";
    note.style.background=note.color;

    note.style.top = note.y+"px";

    game.appendChild(note);
    notes.push(note);

},600);

//--------------------------------
// ノーツ落下
//--------------------------------
function update(){
    if(!playing) return;

    notes.forEach((n,i)=>{
        n.y += 4;
        n.style.top = n.y+"px";

        if(n.y > window.innerHeight){
            n.remove();
            notes.splice(i,1);
        }
    });

    requestAnimationFrame(update);
}
update();

//--------------------------------
// タップ判定（黄色線より上のみ、赤マイナス100点）
//--------------------------------
game.addEventListener("touchstart", e=>{
    if(!playing) return;

    const x = e.touches[0].clientX;

    notes.forEach((n,i)=>{
        const laneStart = n.lane*window.innerWidth/3;
        const laneEnd = (n.lane+1)*window.innerWidth/3;

        // 黄色線より上のノーツのみ判定
        if(n.y <= judgeY && x >= laneStart && x <= laneEnd && Math.abs(n.y - judgeY) <= judgeRange){
            
            if(n.color==="red"){
                score -= 100; // 赤はマイナス100点
            } else {
                score += 100; // 青・緑はプラス100点
            }
            scoreEl.textContent = score;

            playBeep(n.color);
            n.remove();
            notes.splice(i,1);
        }
    });
});

//--------------------------------
// タイマー
//--------------------------------
const timer = setInterval(()=>{
    if(!playing) return;

    timeLeft--;
    timeEl.textContent = timeLeft;

    if(timeLeft <= 0){
        endGame();
    }
},1000);

//--------------------------------
// ランキング保存
//--------------------------------
function endGame(){
    playing=false;
    clearInterval(timer);

    let ranks = JSON.parse(localStorage.getItem("ranks")||"[]");
    ranks.push(score);
    ranks.sort((a,b)=>b-a);
    ranks = ranks.slice(0,5);

    localStorage.setItem("ranks", JSON.stringify(ranks));
    showRanking(ranks);

    alert("終了！スコア："+score);
}

function showRanking(ranks){
    rankingEl.innerHTML="<b>ランキング</b><br>";
    ranks.forEach((r,i)=>{
        rankingEl.innerHTML += `${i+1}位 : ${r}<br>`;
    });
}

showRanking(JSON.parse(localStorage.getItem("ranks")||"[]"));
</script>
</body>
</html>
