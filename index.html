<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<title>館長のリズムゲーム</title>

<style>
body{
    margin:0;
    background:#0b0f1a;
    color:white;
    font-family:sans-serif;
    text-align:center;
    touch-action:manipulation;
}

h1{margin:10px;}

#score{font-size:20px;}

#game{
    position:relative;
    margin:auto;
    width:95vw;
    max-width:600px;
    height:70vh;
    background:#111;
    overflow:hidden;
    border:4px solid #444;
    border-radius:12px;
}

.lane{
    position:absolute;
    bottom:0;
    width:33.33%;
    height:100%;
    border-left:2px solid #333;
}

#hitline{
    position:absolute;
    bottom:120px;
    width:100%;
    height:6px;
    background:yellow;
}

.note{
    position:absolute;
    width:33.33%;
    height:26px;
    background:cyan;
    border-radius:6px;
}

.judge{
    position:absolute;
    width:100%;
    bottom:140px;
    font-size:32px;
    font-weight:bold;
    text-align:center;
    pointer-events:none;
    animation:fade 0.5s forwards;
}

@keyframes fade{
    from{opacity:1;transform:scale(1)}
    to{opacity:0;transform:scale(1.5)}
}

.flash{
    position:absolute;
    border:3px solid white;
    border-radius:50%;
    width:30px;height:30px;
    pointer-events:none;
    animation:ring 0.4s forwards;
}

@keyframes ring{
    from{opacity:1;transform:scale(0.5)}
    to{opacity:0;transform:scale(3)}
}

button{
    margin:10px;
    font-size:22px;
    padding:10px 30px;
}
</style>
</head>

<body>

<h1>館長のリズムゲーム</h1>

<div id="score">
Score: <span id="s">0</span>
Combo: <span id="c">0</span>
</div>

<button onclick="startGame()">スタート</button>

<div id="game" onclick="tap(event)">
    <div class="lane" style="left:0%"></div>
    <div class="lane" style="left:33.33%"></div>
    <div class="lane" style="left:66.66%"></div>
    <div id="hitline"></div>
</div>

<script>
let score=0
let combo=0
let notes=[]
let running=false
let audioCtx=null

function initAudio(){
 if(!audioCtx){
  audioCtx=new(window.AudioContext||window.webkitAudioContext)()
 }
}

function sound(freq){
 const osc=audioCtx.createOscillator()
 const gain=audioCtx.createGain()
 osc.connect(gain)
 gain.connect(audioCtx.destination)
 osc.frequency.value=freq
 gain.gain.value=0.3
 osc.start()
 gain.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.2)
 osc.stop(audioCtx.currentTime+0.2)
}

function startGame(){
 initAudio()
 running=true
}

function spawnNote(){
 if(!running) return
 let lane=Math.floor(Math.random()*3)
 let n=document.createElement("div")
 n.className="note"
 n.style.left=(lane*33.33)+"%"
 n.style.top="0px"
 document.getElementById("game").appendChild(n)
 notes.push({el:n,lane:lane,y:0})
}
setInterval(spawnNote,650)

function gameLoop(){
 if(!running) return
 let hitY=game.offsetHeight-140

 notes.forEach((n,i)=>{
  n.y+=5
  n.el.style.top=n.y+"px"
  if(n.y>hitY+80){
    miss(n,i)
  }
 })
}
setInterval(gameLoop,16)

// ★タップ判定
function tap(e){
 if(!running) return

 let rect=game.getBoundingClientRect()
 let x=e.clientX-rect.left
 let lane=Math.floor(x/(rect.width/3))
 let hitY=game.offsetHeight-140

 // 光エフェクト
 let f=document.createElement("div")
 f.className="flash"
 f.style.left=(x-15)+"px"
 f.style.top=(e.clientY-rect.top-15)+"px"
 game.appendChild(f)
 setTimeout(()=>f.remove(),400)

 for(let i=0;i<notes.length;i++){
  let n=notes[i]
  if(n.lane!==lane) continue

  let diff=Math.abs(n.y-hitY)

  if(diff<18){
    judge("PERFECT","#00ffcc")
    score+=300
    combo++
    sound(900)
  }
  else if(diff<40){
    judge("GOOD","#66aaff")
    score+=100
    combo++
    sound(600)
  }
  else continue

  update()
  n.el.remove()
  notes.splice(i,1)
  return
 }

 combo=0
 update()
}

// 判定表示
function judge(text,color){
 let j=document.createElement("div")
 j.className="judge"
 j.style.color=color
 j.textContent=text
 game.appendChild(j)
 setTimeout(()=>j.remove(),500)
}

function miss(n,i){
 judge("MISS","red")
 combo=0
 update()
 n.el.remove()
 notes.splice(i,1)
}

function update(){
 s.textContent=score
 c.textContent=combo
}
</script>

</body>
</html>
